<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI BANK - é‚è¼¯è¦ºé†’ä¿®å¾©ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --accent-gold: #FFD700; --accent-blue: #00d2ff; --bg-dark: #0a0a0c; }
        body { background-color: var(--bg-dark); color: #e4e4e7; font-family: system-ui, sans-serif; overflow: hidden; }
        .gold-btn { background-color: var(--accent-gold); color: black; font-weight: 900; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        .glass { background: rgba(22, 22, 26, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* å°è¦½åˆ—å„ªåŒ– */
        .nav-item { transition: 0.2s; border-radius: 8px; color: #a1a1aa; cursor: pointer; margin-bottom: 2px; font-size: 13px; }
        .nav-item:hover { background: rgba(255, 255, 255, 0.05); color: white; }
        .nav-item.active { background: var(--accent-gold) !important; color: black !important; font-weight: bold; }
        
        .indent-child { margin-left: 1rem; border-left: 1px solid #27272a; padding-left: 10px; }
        .indent-grand { margin-left: 2rem; border-left: 1px solid #27272a; padding-left: 10px; font-size: 11px; }
        
        .search-bar { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        .search-bar:focus-within { border-color: var(--accent-gold); background: rgba(255,255,255,0.1); }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <aside class="w-full md:w-72 bg-[#0d0d0f] md:h-full overflow-y-auto border-r border-white/5 p-4 flex flex-col">
        <div class="mb-6 px-2">
            <h2 class="text-gray-500 text-[10px] font-bold uppercase tracking-widest mb-4">Search</h2>
            <div class="search-bar flex items-center px-3 py-2 rounded-xl">
                <i class="fas fa-search text-gray-500 text-xs mr-2"></i>
                <input type="text" id="searchInput" oninput="search(this.value)" placeholder="æœå°‹ Prompt..." class="bg-transparent text-sm outline-none w-full">
            </div>
        </div>

        <h2 class="text-gray-500 text-[10px] font-bold px-2 uppercase tracking-widest mb-2">ä¸»é¡Œåˆ†é¡</h2>
        <div id="sideNav" class="flex-1 space-y-1">
            </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="h-20 flex justify-between items-center px-6 glass shrink-0">
            <h1 class="text-xl font-black text-white italic">AI <span class="text-accent-gold">BANK</span> <span class="text-[10px] font-normal text-gray-500 ml-2">ADMIN V2</span></h1>
            <button onclick="openModal()" class="gold-btn px-6 py-2 rounded-full text-sm">
                <i class="fas fa-plus mr-2"></i>ä¸Šå‚³è³‡ç”¢
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div id="assetsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </main>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-[300]">
        <div class="glass w-full max-w-lg rounded-[30px] p-1 border-2 border-accent-gold">
            <div class="max-h-[90vh] overflow-y-auto p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 id="modalTitle" class="text-xl font-bold text-accent-gold">ç®¡ç†æ§åˆ¶å°</h3>
                    <button onclick="closeModal()" class="text-gray-500 text-2xl">&times;</button>
                </div>

                <div class="border-2 border-dashed border-gray-800 rounded-2xl p-4 text-center cursor-pointer" onclick="document.getElementById('fIn').click()">
                    <input type="file" id="fIn" accept="image/*" class="hidden" onchange="preview(this)">
                    <img id="v" class="hidden w-full rounded-xl object-contain mb-2">
                    <div id="hint" class="text-gray-500 text-xs">é»æ“Šæ›´æ›å°é¢åœ–ç‰‡</div>
                </div>

                <div class="grid grid-cols-1 gap-3">
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] text-gray-500 ml-2">çˆ¶å±¤ç´š (Parent)</label>
                        <div class="flex gap-2" id="pn_box">
                            <select id="pn" class="flex-1 bg-black border border-gray-800 rounded-xl p-3 text-sm"></select>
                            <button onclick="toggleInput('pn')" class="bg-gray-800 px-4 rounded-xl text-[10px]">æ‰‹æ‰“/é¸æ“‡</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] text-gray-500 ml-2">å­å±¤ç´š (Child)</label>
                        <div class="flex gap-2" id="sn_box">
                            <select id="sn" class="flex-1 bg-black border border-gray-800 rounded-xl p-3 text-sm"></select>
                            <button onclick="toggleInput('sn')" class="bg-gray-800 px-4 rounded-xl text-[10px]">æ‰‹æ‰“/é¸æ“‡</button>
                        </div>
                    </div>
                    <div class="flex flex-col gap-1">
                        <label class="text-[10px] text-gray-500 ml-2">å­«å±¤ç´š (Grand)</label>
                        <div class="flex gap-2" id="gn_box">
                            <select id="gn" class="flex-1 bg-black border border-gray-800 rounded-xl p-3 text-sm"></select>
                            <button onclick="toggleInput('gn')" class="bg-gray-800 px-4 rounded-xl text-[10px]">æ‰‹æ‰“/é¸æ“‡</button>
                        </div>
                    </div>
                </div>

                <textarea id="pc" placeholder="Prompt å…§å®¹..." class="w-full bg-black border border-gray-800 rounded-2xl p-4 h-32 text-sm outline-none focus:border-accent-gold"></textarea>
                
                <input type="hidden" id="editingId">
                <div class="flex gap-3">
                    <button id="sBtn" onclick="saveData()" class="gold-btn w-full py-4 rounded-2xl text-lg">ç¢ºèªåŒæ­¥ä¸¦æ¬å®¶</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // è¨­å®šå€ (ç¶­æŒåŸæ¨£)
        const TK = "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";
        const CF = { owner: "ibartifact-source", repo: "jimong-search", path: "resources/data.json", img: "resources/images/" };
        let allData = []; let selF = null;

        async function load() {
            try {
                const g = await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}?t=${Date.now()}`, { headers: { "Authorization": `token ${TK}` } });
                const j = await g.json();
                allData = JSON.parse(decodeURIComponent(escape(atob(j.content.replace(/\s/g, '')))));
                renderNav(); renderCards(allData);
            } catch (e) { console.error("åŠ è¼‰å¤±æ•—", e); }
        }

        // æ ¸å¿ƒä¿®æ­£ï¼šå·¢ç‹€å°è¦½æ¸²æŸ“é‚è¼¯
        function renderNav() {
            const nav = document.getElementById('sideNav');
            nav.innerHTML = `<div onclick="filterBy('all', 'all', this)" class="nav-item active px-4 py-3 flex justify-between items-center"><span>å…¨éƒ¨è³‡ç”¢</span><span class="text-[10px] opacity-50">${allData.length}</span></div>`;
            
            const tree = {};
            allData.forEach(i => {
                if(!tree[i.parent]) tree[i.parent] = {};
                if(!tree[i.parent][i.child]) tree[i.parent][i.child] = new Set();
                if(i.grand) tree[i.parent][i.child].add(i.grand);
            });

            for (const p in tree) {
                nav.innerHTML += `<div onclick="filterBy('parent', '${p}', this)" class="nav-item px-4 py-2 mt-2 font-bold">ğŸ“ ${p}</div>`;
                for (const s in tree[p]) {
                    nav.innerHTML += `<div onclick="filterBy('child', '${s}', this)" class="nav-item indent-child px-4 py-1.5 text-gray-400">â†³ ${s}</div>`;
                    tree[p][s].forEach(g => {
                        // é€™è£¡ç¢ºä¿äº†å­«å±¤ç´šæ˜¯æ›åœ¨æ­£ç¢ºçš„çˆ¶å­è·¯å¾‘ä¸‹çš„
                        nav.innerHTML += `<div onclick="filterBy('grand', '${g}', this)" class="nav-item indent-grand px-4 py-1 text-gray-500">â”” ${g}</div>`;
                    });
                }
            }
        }

        function filterBy(type, val, el) {
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if(el) el.classList.add('active');
            const filtered = val === 'all' ? allData : allData.filter(i => i[type] === val);
            renderCards(filtered);
        }

        function search(val) {
            const v = val.toLowerCase();
            const filtered = allData.filter(i => i.prompt.toLowerCase().includes(v) || i.parent.toLowerCase().includes(v));
            renderCards(filtered);
        }

        function openModal(editItem = null) {
            document.getElementById('addModal').classList.remove('hidden');
            initSelects();
            const v = document.getElementById('v');
            const hint = document.getElementById('hint');

            if(editItem) {
                document.getElementById('modalTitle').innerText = "ç·¨è¼¯è³‡ç”¢ (å¯æ›´æ›å±¤ç´šæ¬å®¶)";
                document.getElementById('pn').value = editItem.parent;
                document.getElementById('sn').value = editItem.child;
                document.getElementById('gn').value = editItem.grand || '';
                document.getElementById('pc').value = editItem.prompt;
                document.getElementById('editingId').value = editItem.id;
                v.src = `https://raw.githubusercontent.com/${CF.owner}/${CF.repo}/main/${CF.img}${editItem.image_name}`;
                v.classList.remove('hidden');
                hint.classList.add('hidden');
            } else {
                document.getElementById('modalTitle').innerText = "æ–°å¢è³‡ç”¢";
                document.getElementById('editingId').value = "";
                document.getElementById('pc').value = "";
                v.src = ""; v.classList.add('hidden'); hint.classList.remove('hidden');
                selF = null;
            }
        }

        async function saveData() {
            const btn = document.getElementById('sBtn');
            const editId = document.getElementById('editingId').value;
            btn.disabled = true; btn.innerText = "æ­£åœ¨åŒæ­¥æ•¸æ“šèˆ‡å±¤ç´š...";
            
            try {
                let imgName = "";
                if(selF) {
                    imgName = `${Date.now()}_${selF.name}`;
                    const b64 = await new Promise(res => { const r = new FileReader(); r.onload = () => res(r.result.split(',')[1]); r.readAsDataURL(selF); });
                    await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.img}${imgName}`, {
                        method: "PUT", headers: { "Authorization": `token ${TK}` }, body: JSON.stringify({ message: "img", content: b64 })
                    });
                }

                const g = await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, { headers: { "Authorization": `token ${TK}` } });
                const j = await g.json();
                let db = JSON.parse(decodeURIComponent(escape(atob(j.content.replace(/\s/g, '')))));
                
                const newItem = {
                    id: editId || Date.now(),
                    parent: document.getElementById('pn').value,
                    child: document.getElementById('sn').value,
                    grand: document.getElementById('gn').value,
                    prompt: document.getElementById('pc').value,
                    image_name: imgName || (editId ? db.find(x => x.id == editId).image_name : "")
                };

                if(editId) {
                    const idx = db.findIndex(x => x.id == editId);
                    db[idx] = newItem; // ç›´æ¥æ›¿æ›ï¼Œå¯¦ç¾æ¬å®¶
                } else {
                    db.push(newItem);
                }

                await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, {
                    method: "PUT", headers: { "Authorization": `token ${TK}` },
                    body: JSON.stringify({ message: "db sync", content: btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2)))), sha: j.sha })
                });
                location.reload();
            } catch (e) { alert("åŒæ­¥å¤±æ•—ï¼š" + e.message); btn.disabled = false; }
        }

        async function deleteItem(id) {
            if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿå°æ‡‰çš„å±¤ç´šè‹¥ç„¡è³‡ç”¢ä¹Ÿå°‡è‡ªå‹•æ¶ˆå¤±ã€‚")) return;
            try {
                const g = await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, { headers: { "Authorization": `token ${TK}` } });
                const j = await g.json();
                let db = JSON.parse(decodeURIComponent(escape(atob(j.content.replace(/\s/g, '')))));
                await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, {
                    method: "PUT", headers: { "Authorization": `token ${TK}` },
                    body: JSON.stringify({ message: "delete", content: btoa(unescape(encodeURIComponent(JSON.stringify(db.filter(i => i.id != id), null, 2)))), sha: j.sha })
                });
                location.reload();
            } catch (e) { alert("åˆªé™¤å¤±æ•—"); }
        }

        function renderCards(data) {
            const grid = document.getElementById('assetsGrid');
            grid.innerHTML = '';
            data.slice().reverse().forEach(i => {
                grid.innerHTML += `
                    <div class="glass p-4 rounded-3xl group relative border border-white/5 hover:border-accent-gold/50 transition">
                        <div class="absolute top-4 right-4 flex gap-2 opacity-0 group-hover:opacity-100 transition z-10">
                            <button onclick='openModal(${JSON.stringify(i)})' class="bg-blue-600 w-8 h-8 rounded-full text-[10px]"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem('${i.id}')" class="bg-red-600 w-8 h-8 rounded-full text-[10px]"><i class="fas fa-trash"></i></button>
                        </div>
                        <img src="https://raw.githubusercontent.com/${CF.owner}/${CF.repo}/main/${CF.img}${i.image_name}" class="w-full h-48 object-contain bg-black rounded-2xl mb-3">
                        <div class="text-[10px] text-accent-blue font-bold mb-1 uppercase">${i.parent} > ${i.child}</div>
                        <div class="text-white font-bold text-sm mb-1">${i.grand || 'é è¨­å…§å®¹'}</div>
                        <div class="text-gray-500 text-[10px] line-clamp-2 leading-relaxed">${i.prompt}</div>
                    </div>`;
            });
        }

        function initSelects() {
            const pSet = new Set(), sSet = new Set(), gSet = new Set();
            allData.forEach(i => { pSet.add(i.parent); sSet.add(i.child); if(i.grand) gSet.add(i.grand); });
            const fill = (id, set) => {
                const el = document.getElementById(id);
                if(!el || el.tagName !== 'SELECT') return;
                el.innerHTML = '<option value="">é¸æ“‡ç¾æœ‰...</option>';
                set.forEach(v => el.innerHTML += `<option value="${v}">${v}</option>`);
            };
            fill('pn', pSet); fill('sn', sSet); fill('gn', gSet);
        }

        function toggleInput(id) {
            const box = document.getElementById(id + '_box');
            if(box.firstElementChild.tagName === 'SELECT') {
                box.innerHTML = `<input id="${id}" class="flex-1 bg-black border border-accent-gold rounded-xl p-3 text-sm" placeholder="è¼¸å…¥æ–°åç¨±...">
                                <button onclick="toggleInput('${id}')" class="bg-accent-gold text-black px-4 rounded-xl text-[10px]">é¸å›</button>`;
            } else {
                box.innerHTML = `<select id="${id}" class="flex-1 bg-black border border-gray-800 rounded-xl p-3 text-sm"></select>
                                <button onclick="toggleInput('${id}')" class="bg-gray-800 px-4 rounded-xl text-[10px]">æ‰‹æ‰“/é¸æ“‡</button>`;
                initSelects();
            }
        }

        function preview(i) {
            if(i.files[0]) {
                selF = i.files[0];
                const r = new FileReader();
                r.onload = e => {
                    const v = document.getElementById('v');
                    v.src = e.target.result;
                    v.classList.remove('hidden');
                    document.getElementById('hint').classList.add('hidden');
                };
                r.readAsDataURL(selF);
            }
        }

        function closeModal() { document.getElementById('addModal').classList.add('hidden'); }
        load();
    </script>
</body>
</html>
