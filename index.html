<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI BANK - ç®¡ç†å“¡æ ¸å¿ƒç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root { --accent-gold: #FFD700; --accent-blue: #00d2ff; --bg-dark: #0a0a0c; }
        body { background-color: var(--bg-dark); color: #e4e4e7; font-family: system-ui, sans-serif; }
        .gold-btn { background-color: var(--accent-gold); color: black; font-weight: 900; box-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
        .glass { background: rgba(22, 22, 26, 0.95); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        
        /* æ‰‹æ©Ÿé©é…è‡ªé©æ‡‰ä½ˆå±€ */
        @media (max-width: 768px) {
            .sidebar { position: fixed; bottom: 0; width: 100%; height: 60px; z-index: 100; border-top: 1px solid #333; overflow-x: auto; display: flex; flex-direction: row !important; }
            .sidebar-content { display: flex; flex-direction: row !important; gap: 10px; width: auto; padding: 10px; }
            main { padding-bottom: 80px; }
            .nav-item { white-space: nowrap; font-size: 12px; padding: 5px 15px !important; }
        }
        
        .nav-item.active { background: var(--accent-gold); color: black; font-weight: bold; }
        .card-actions { opacity: 0; transition: 0.3s; }
        .group:hover .card-actions { opacity: 1; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row">

    <aside class="sidebar w-full md:w-64 bg-[#0d0d0f] md:h-full overflow-y-auto border-r border-white/5">
        <div class="sidebar-content p-4 flex flex-col gap-2">
            <h2 class="hidden md:block text-gray-500 text-xs font-bold mb-4 px-2 uppercase tracking-widest">ä¸»é¡Œå°èˆª</h2>
            <div id="sideNav" class="flex flex-row md:flex-col gap-2">
                <div onclick="filterBy('all')" class="nav-item active px-4 py-3 rounded-xl cursor-pointer hover:bg-white/5 transition">
                    <i class="fas fa-th-large mr-2"></i> å…¨éƒ¨
                </div>
            </div>
        </div>
    </aside>

    <div class="flex-1 flex flex-col overflow-hidden">
        <header class="h-20 flex justify-between items-center px-6 glass shrink-0">
            <h1 class="text-xl font-black text-accent-blue md:block hidden">AI PROMPT BANK</h1>
            <div class="flex-1 max-w-xl mx-4">
                <div class="relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                    <input type="text" id="searchInput" oninput="doSearch()" placeholder="æœå°‹çˆ¶/å­/å­«å±¤ç´šæˆ–å’’èª..." 
                           class="w-full bg-black/50 border border-gray-700 rounded-full py-2 pl-12 pr-4 focus:border-accent-gold outline-none text-sm">
                </div>
            </div>
            <button onclick="openModal()" class="gold-btn px-6 py-2 rounded-full text-sm shrink-0">
                <i class="fas fa-plus"></i> <span class="hidden md:inline ml-2">ä¸Šå‚³</span>
            </button>
        </header>

        <main class="flex-1 overflow-y-auto p-4 md:p-8">
            <div id="assetsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </main>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black/95 hidden flex items-center justify-center p-4 z-[300]">
        <div class="glass w-full max-w-lg rounded-[30px] p-6 border-2 border-accent-gold">
            <h3 id="modalTitle" class="text-xl font-bold text-accent-gold mb-6 text-center">æ–°å¢/ç·¨è¼¯è³‡ç”¢</h3>
            <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                <div id="uploadZone" class="border-2 border-dashed border-gray-700 rounded-2xl p-6 text-center cursor-pointer hover:border-accent-gold transition" onclick="document.getElementById('fIn').click()">
                    <input type="file" id="fIn" accept="image/*" class="hidden" onchange="preview(this)">
                    <div id="hint">é¸å–åœ–ç‰‡</div>
                    <img id="v" class="hidden w-full max-h-40 object-contain rounded-xl">
                </div>
                <div class="grid grid-cols-3 gap-2 text-xs">
                    <input type="text" id="pn" placeholder="çˆ¶ä¸»é¡Œ" class="bg-black border border-gray-700 rounded-lg p-3">
                    <input type="text" id="sn" placeholder="å­å ´æ™¯" class="bg-black border border-gray-700 rounded-lg p-3">
                    <input type="text" id="gn" placeholder="å­«ç´°ç¯€(å¯é¸)" class="bg-black border border-gray-700 rounded-lg p-3">
                </div>
                <textarea id="pc" placeholder="è²¼ä¸Šå’’èª..." class="w-full bg-black border border-gray-700 rounded-xl p-4 h-32 text-sm"></textarea>
                <input type="hidden" id="editingId">
                <button id="sBtn" onclick="saveData()" class="gold-btn w-full py-4 rounded-xl text-lg">ğŸ’¾ å„²å­˜ä¸¦åŒæ­¥åˆ° GITHUB</button>
                <button onclick="closeModal()" class="w-full text-gray-500 py-2">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        const p1 = "ghp_zlzYjbKiupYN"; const p2 = "KKSAdOSSTrI2t60qE40TuDkq";
        const TK = p1 + p2;
        const CF = { owner: "ibartifact-source", repo: "jimong-search", path: "resources/data.json", img: "resources/images/" };
        let allData = []; let selF = null;

        function openModal(editItem = null) {
            document.getElementById('addModal').classList.remove('hidden');
            if(editItem) {
                document.getElementById('modalTitle').innerText = "ç·¨è¼¯è³‡ç”¢å…§å®¹";
                document.getElementById('pn').value = editItem.parent;
                document.getElementById('sn').value = editItem.child;
                document.getElementById('gn').value = editItem.grand || '';
                document.getElementById('pc').value = editItem.prompt;
                document.getElementById('editingId').value = editItem.id;
                document.getElementById('uploadZone').classList.add('hidden'); // ç·¨è¼¯æ™‚ä¸å¼·åˆ¶æ›åœ–
            } else {
                document.getElementById('modalTitle').innerText = "æ–°å¢ AI è³‡ç”¢";
                document.getElementById('editingId').value = '';
                document.getElementById('uploadZone').classList.remove('hidden');
            }
        }

        function closeModal() { document.getElementById('addModal').classList.add('hidden'); selF = null; document.getElementById('v').src = ''; }

        function preview(i) { if(i.files[0]) { selF=i.files[0]; const r=new FileReader(); r.onload=e=>{document.getElementById('v').src=e.target.result;document.getElementById('v').classList.remove('hidden');document.getElementById('hint').classList.add('hidden');}; r.readAsDataURL(selF); } }

        async function saveData() {
            const btn = document.getElementById('sBtn');
            const editId = document.getElementById('editingId').value;
            btn.disabled = true; btn.innerText = "è™•ç†ä¸­...";

            try {
                let currentImg = "";
                if (selF) {
                    const fn = `${Date.now()}_${selF.name}`;
                    const r = new FileReader();
                    const b64 = await new Promise(res => { r.onload = () => res(r.result.split(',')[1]); r.readAsDataURL(selF); });
                    await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.img}${fn}`, {
                        method: "PUT", headers: { "Authorization": `token ${TK}` },
                        body: JSON.stringify({ message: "upload", content: b64 })
                    });
                    currentImg = fn;
                }

                const g = await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, { headers: { "Authorization": `token ${TK}` } });
                const j = await g.json();
                let db = JSON.parse(decodeURIComponent(escape(atob(j.content.replace(/\s/g, '')))));

                if (editId) {
                    const idx = db.findIndex(i => i.id == editId);
                    db[idx] = { ...db[idx], 
                        parent: document.getElementById('pn').value,
                        child: document.getElementById('sn').value,
                        grand: document.getElementById('gn').value,
                        prompt: document.getElementById('pc').value
                    };
                } else {
                    db.push({ 
                        id: Date.now(), 
                        parent: document.getElementById('pn').value, 
                        child: document.getElementById('sn').value, 
                        grand: document.getElementById('gn').value, 
                        prompt: document.getElementById('pc').value, 
                        image_name: currentImg 
                    });
                }

                await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, {
                    method: "PUT", headers: { "Authorization": `token ${TK}` },
                    body: JSON.stringify({ message: "update", content: btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2)))), sha: j.sha })
                });

                alert("åŒæ­¥æˆåŠŸï¼"); location.reload();
            } catch (e) { alert(e.message); btn.disabled = false; }
        }

        async function deleteItem(id) {
            if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ(GitHub ä¸Šçš„åœ–ä»æœƒä¿ç•™ï¼Œåƒ…åˆªé™¤ç´¢å¼•)")) return;
            const g = await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, { headers: { "Authorization": `token ${TK}` } });
            const j = await g.json();
            let db = JSON.parse(decodeURIComponent(escape(atob(j.content.replace(/\s/g, '')))));
            db = db.filter(i => i.id != id);
            await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}`, {
                method: "PUT", headers: { "Authorization": `token ${TK}` },
                body: JSON.stringify({ message: "delete", content: btoa(unescape(encodeURIComponent(JSON.stringify(db, null, 2)))), sha: j.sha })
            });
            location.reload();
        }

        async function load() {
            const g = await fetch(`https://api.github.com/repos/${CF.owner}/${CF.repo}/contents/${CF.path}?t=${Date.now()}`, { headers: { "Authorization": `token ${TK}` } });
            const j = await g.json();
            allData = JSON.parse(decodeURIComponent(escape(atob(j.content.replace(/\s/g, '')))));
            renderNav(); renderCards(allData);
        }

        function renderNav() {
            const nav = document.getElementById('sideNav');
            const parents = [...new Set(allData.map(i => i.parent))];
            parents.forEach(p => {
                nav.innerHTML += `<div onclick="filterBy('parent', '${p}')" class="nav-item px-4 py-2 text-sm rounded-lg cursor-pointer hover:bg-white/5">${p}</div>`;
            });
        }

        function renderCards(data) {
            const grid = document.getElementById('assetsGrid');
            grid.innerHTML = '';
            data.slice().reverse().forEach(i => {
                grid.innerHTML += `
                    <div class="glass p-4 rounded-3xl group relative transition hover:border-accent-gold">
                        <div class="card-actions absolute top-2 right-2 flex gap-2 z-10">
                            <button onclick='openModal(${JSON.stringify(i)})' class="bg-blue-600/80 p-2 rounded-lg text-xs"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem(${i.id})" class="bg-red-600/80 p-2 rounded-lg text-xs"><i class="fas fa-trash"></i></button>
                        </div>
                        <img src="https://raw.githubusercontent.com/${CF.owner}/${CF.repo}/main/${CF.img}${i.image_name}" class="w-full h-48 object-contain bg-black rounded-2xl mb-3">
                        <div class="flex flex-wrap gap-1 mb-2">
                            <span class="text-[10px] px-2 py-0.5 bg-accent-blue/20 text-accent-blue rounded-full">${i.child}</span>
                            <span class="text-[10px] px-2 py-0.5 bg-accent-gold/20 text-accent-gold rounded-full">${i.grand || 'é è¨­'}</span>
                        </div>
                        <div class="text-white font-bold text-sm truncate">${i.parent}</div>
                        <div class="text-gray-500 text-[10px] line-clamp-2 mt-1">${i.prompt}</div>
                    </div>`;
            });
        }

        function doSearch() {
            const t = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allData.filter(i => 
                i.parent.toLowerCase().includes(t) || 
                (i.child && i.child.toLowerCase().includes(t)) || 
                (i.grand && i.grand.toLowerCase().includes(t)) || 
                i.prompt.toLowerCase().includes(t)
            );
            renderCards(filtered);
        }

        function filterBy(type, val) {
            renderCards(val === 'all' ? allData : allData.filter(i => i[type] === val));
        }

        load();
    </script>
</body>
</html>
